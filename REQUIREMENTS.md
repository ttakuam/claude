# 中古車WEBアプリ - 要件定義書

## 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [技術スタック](#技術スタック)
3. [機能要件](#機能要件)
4. [非機能要件](#非機能要件)
5. [データ構造](#データ構造)
6. [画面設計](#画面設計)
7. [API設計](#api設計)
8. [セキュリティ要件](#セキュリティ要件)

---

## プロジェクト概要

### 目的
中古車販売店向けの在庫管理・顧客問い合わせ対応を行うWebアプリケーションのMVP（Minimum Viable Product）を構築する。

### スコープ
- ユーザー向け：車両閲覧、検索、問い合わせ機能
- 管理者向け：車両管理、CSVインポート、問い合わせ管理機能

### 想定ユーザー
- **エンドユーザー**：中古車購入を検討している一般消費者
- **管理者**：販売店スタッフ（在庫管理・顧客対応担当）

---

## 技術スタック

### フロントエンド
- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **UI**: Lucide React (アイコン)

### バックエンド
- **フレームワーク**: Next.js API Routes
- **データベース**: Supabase (PostgreSQL)
- **認証**: Supabase Auth
- **ストレージ**: Supabase Storage

### インフラ・サービス
- **ホスティング**: Vercel
- **メール送信**: Resend
- **バージョン管理**: Git / GitHub

---

## 機能要件

### 1. ユーザー向け機能

#### 1.1 車両一覧表示
- **機能**: 公開中の車両をカード形式で一覧表示
- **表示項目**:
  - サムネイル画像
  - メーカー・車種・グレード
  - 価格
  - 年式
  - 走行距離
  - 修復歴バッジ
- **ソート**: 登録日時の降順（新着順）

#### 1.2 車両詳細表示
- **機能**: 車両の詳細情報と画像ギャラリーを表示
- **表示項目**:
  - 複数画像（ギャラリー形式、スライダー対応）
  - 基本スペック（メーカー、車種、グレード、価格、年式、走行距離、車検期限、修復歴）
  - 備考欄
  - 問い合わせフォーム
- **画像ギャラリー**:
  - メイン画像表示
  - サムネイル一覧
  - 左右スライド機能

#### 1.3 検索・絞り込み機能
- **検索条件**:
  - メーカー（ドロップダウン）
  - 価格帯（下限・上限）
  - 年式（下限・上限）
  - 走行距離（上限）
  - 修復歴の有無（チェックボックス）
- **UI**:
  - 詳細検索の開閉機能
  - アクティブフィルター数の表示
  - クリアボタン
- **結果表示**: 絞り込み結果件数の表示

#### 1.4 お気に入り機能
- **機能**: ログインなしでお気に入り登録
- **保存方法**: LocalStorage
- **表示**:
  - ヘッダーにお気に入り件数バッジ
  - お気に入り一覧ページ
- **操作**:
  - ハートアイコンで追加/削除
  - 一覧・詳細ページの両方で操作可能

#### 1.5 問い合わせ/来店予約フォーム
- **入力項目**:
  - 問い合わせ種類（お問い合わせ / 来店予約）
  - お名前（必須）
  - メールアドレス（必須）
  - 電話番号（任意）
  - メッセージ（任意）
- **機能**:
  - 対象車両情報の自動付与
  - バリデーション
  - 送信完了メッセージ
- **送信先**:
  - データベースに保存
  - 管理者メールに通知

---

### 2. 管理者向け機能

#### 2.1 認証
- **方式**: メール+パスワード認証（Supabase Auth）
- **ログイン画面**: `/admin/login`
- **セッション管理**: Supabase Auth自動管理
- **保護ルート**: 未認証時は自動的にログイン画面へリダイレクト

#### 2.2 ダッシュボード
- **統計情報表示**:
  - 総車両数
  - 公開中の車両数
  - 成約済の車両数
  - 問い合わせ総数
- **クイックアクション**:
  - 新規車両登録ボタン
  - CSVインポートボタン
  - 問い合わせ確認ボタン
- **最近の問い合わせ**: 最新5件を表示

#### 2.3 車両管理

##### 2.3.1 車両一覧
- **表示項目**:
  - サムネイル画像
  - 車両ID
  - 車両情報（メーカー・車種・年式・走行距離）
  - 価格
  - ステータス（公開中/成約済）
- **操作**:
  - 編集ボタン
  - 削除ボタン（確認ダイアログ付き）
  - ステータス切り替えボタン

##### 2.3.2 車両登録/編集フォーム
- **基本情報入力**:
  - 車両ID（必須、ユニーク）
  - メーカー（必須）
  - 車種（必須）
  - グレード（任意）
  - 価格（必須）
  - 年式（必須）
  - 走行距離（必須）
  - 車検期限（任意）
  - 修復歴（チェックボックス）
  - ステータス（公開中/成約済）
  - 備考（任意、テキストエリア）
- **画像アップロード**:
  - 複数画像の同時アップロード
  - ドラッグ&ドロップ対応
  - プレビュー表示
  - 表示順の管理（アップロード順）
  - 個別削除機能
- **バリデーション**:
  - 必須項目チェック
  - 数値型チェック
  - 車両ID重複チェック

#### 2.4 CSVインポート機能
- **機能**: 車両スペックを一括登録
- **対応形式**: CSV（ヘッダー行必須）
- **必須列**:
  - vehicle_id
  - manufacturer
  - model
  - price
  - year
  - mileage
  - accident_history
- **任意列**:
  - grade
  - inspection_date
  - notes
- **処理フロー**:
  1. CSVファイル選択
  2. プレビュー表示（最初の5件）
  3. インポート実行
  4. 結果表示（成功件数/失敗件数）
- **注意事項**: 画像は後から個別に管理画面で登録

#### 2.5 問い合わせ管理
- **一覧表示項目**:
  - お客様名
  - メールアドレス
  - 電話番号
  - 問い合わせ種類（お問い合わせ/来店予約）
  - 対象車両情報
  - メッセージ内容
  - 受信日時
- **ソート**: 受信日時の降順
- **操作**:
  - メールアドレス・電話番号のクリックで連絡可能
  - 車両情報の表示

---

## 非機能要件

### パフォーマンス
- **ページ読み込み**: 3秒以内（初回アクセス）
- **画像最適化**: Next.js Image コンポーネント使用
- **データベースクエリ**: インデックス最適化

### セキュリティ
- **認証**: Supabase Auth使用
- **RLS (Row Level Security)**: データベースレベルでのアクセス制御
- **環境変数**: APIキーの安全な管理
- **HTTPS**: Vercel自動提供

### 可用性
- **稼働率**: 99.9%（Vercel・Supabase SLA）
- **バックアップ**: Supabase自動バックアップ

### スケーラビリティ
- **同時接続**: 100ユーザー程度を想定
- **データ量**: 車両500台程度まで対応
- **画像ストレージ**: Supabase Storage（無料枠：1GB）

### ブラウザ対応
- **デスクトップ**: Chrome、Firefox、Safari、Edge（最新版）
- **モバイル**: iOS Safari、Android Chrome（最新版）
- **レスポンシブ**: スマートフォン、タブレット、デスクトップ対応

---

## データ構造

### データベーステーブル

#### vehicles テーブル
| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|------|------|-----------|------|
| id | UUID | NO | gen_random_uuid() | 主キー |
| vehicle_id | VARCHAR(50) | NO | - | 車両ID（ユニーク） |
| manufacturer | VARCHAR(100) | NO | - | メーカー |
| model | VARCHAR(100) | NO | - | 車種 |
| grade | VARCHAR(100) | YES | NULL | グレード |
| price | INTEGER | NO | - | 価格（円） |
| year | INTEGER | NO | - | 年式 |
| mileage | INTEGER | NO | - | 走行距離（km） |
| inspection_date | DATE | YES | NULL | 車検期限 |
| accident_history | BOOLEAN | NO | false | 修復歴 |
| notes | TEXT | YES | NULL | 備考 |
| status | VARCHAR(20) | NO | 'published' | ステータス |
| created_at | TIMESTAMP | NO | NOW() | 作成日時 |
| updated_at | TIMESTAMP | NO | NOW() | 更新日時 |

**インデックス**:
- `vehicle_id` (UNIQUE)
- `status`
- `manufacturer`
- `price`

#### vehicle_images テーブル
| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|------|------|-----------|------|
| id | UUID | NO | gen_random_uuid() | 主キー |
| vehicle_id | UUID | NO | - | 外部キー（vehicles.id） |
| image_url | TEXT | NO | - | 画像URL |
| display_order | INTEGER | NO | 0 | 表示順 |
| created_at | TIMESTAMP | NO | NOW() | 作成日時 |

**インデックス**:
- `vehicle_id`

**外部キー**:
- `vehicle_id` → `vehicles(id)` ON DELETE CASCADE

#### inquiries テーブル
| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|------|------|-----------|------|
| id | UUID | NO | gen_random_uuid() | 主キー |
| vehicle_id | UUID | YES | NULL | 外部キー（vehicles.id） |
| name | VARCHAR(100) | NO | - | お名前 |
| email | VARCHAR(255) | NO | - | メールアドレス |
| phone | VARCHAR(20) | YES | NULL | 電話番号 |
| inquiry_type | VARCHAR(20) | NO | - | 種類 |
| message | TEXT | YES | NULL | メッセージ |
| created_at | TIMESTAMP | NO | NOW() | 作成日時 |

**インデックス**:
- `created_at`

**外部キー**:
- `vehicle_id` → `vehicles(id)` ON DELETE SET NULL

### Row Level Security (RLS) ポリシー

#### vehicles テーブル
- **SELECT**: 公開中（status='published'）の車両は誰でも閲覧可能
- **INSERT/UPDATE/DELETE**: 認証済みユーザーのみ

#### vehicle_images テーブル
- **SELECT**: 誰でも閲覧可能
- **INSERT/UPDATE/DELETE**: 認証済みユーザーのみ

#### inquiries テーブル
- **SELECT**: 認証済みユーザーのみ
- **INSERT**: 誰でも可能（問い合わせ送信）

---

## 画面設計

### ユーザー向け画面

#### トップページ（車両一覧）
- **URL**: `/`
- **レイアウト**:
  - ヘッダー（ロゴ、お気に入りリンク）
  - ヒーローセクション
  - 検索フィルター
  - 車両カードグリッド（3列）
  - フッター

#### 車両詳細ページ
- **URL**: `/vehicles/[id]`
- **レイアウト**:
  - ヘッダー
  - 2カラムレイアウト
    - 左: 画像ギャラリー、スペック情報
    - 右: 問い合わせフォーム（sticky）
  - フッター

#### お気に入りページ
- **URL**: `/favorites`
- **レイアウト**:
  - ヘッダー
  - ヒーローセクション
  - お気に入り車両グリッド
  - フッター

### 管理者向け画面

#### ログインページ
- **URL**: `/admin/login`
- **レイアウト**: 中央配置のログインフォーム

#### 管理画面共通レイアウト
- **ヘッダー**: ロゴ、ユーザー情報、ログアウトボタン
- **サイドバー**: メニュー
  - ダッシュボード
  - 車両管理
  - 問い合わせ
  - CSVインポート
- **メインコンテンツエリア**

#### ダッシュボード
- **URL**: `/admin/dashboard`
- **表示内容**: 統計カード、クイックアクション、最近の問い合わせ

#### 車両一覧
- **URL**: `/admin/vehicles`
- **表示内容**: テーブル形式の車両一覧、新規登録ボタン

#### 車両登録/編集
- **URL**: `/admin/vehicles/new`, `/admin/vehicles/[id]/edit`
- **表示内容**: フォーム（基本情報、画像アップロード）

#### CSVインポート
- **URL**: `/admin/import`
- **表示内容**: ファイル選択、プレビュー、インポートボタン

#### 問い合わせ一覧
- **URL**: `/admin/inquiries`
- **表示内容**: 問い合わせカード一覧

---

## API設計

### 問い合わせAPI
- **エンドポイント**: `POST /api/inquiries`
- **リクエストボディ**:
```json
{
  "vehicleId": "uuid",
  "vehicleInfo": "トヨタ プリウス S",
  "name": "山田太郎",
  "email": "yamada@example.com",
  "phone": "090-1234-5678",
  "inquiryType": "inquiry",
  "message": "詳細を教えてください"
}
```
- **レスポンス**:
```json
{
  "success": true
}
```

### 車両CRUD
- Supabase JavaScript Client を使用
- クライアントサイドでの直接アクセス（RLSで保護）

---

## セキュリティ要件

### 認証・認可
- **管理画面**: Supabase Auth による認証必須
- **RLS**: データベースレベルでのアクセス制御
- **セッション管理**: Supabase Auth 自動管理

### データ保護
- **環境変数**: `.env.local` でAPIキー管理（Gitには含めない）
- **HTTPS**: Vercel自動提供
- **XSS対策**: React自動エスケープ
- **CSRF対策**: Next.js自動保護

### ファイルアップロード
- **許可形式**: 画像のみ（jpg、png、gif、webp）
- **ファイルサイズ**: Supabaseデフォルト制限
- **ストレージ**: Supabase Storage（公開バケット）

---

## 今後の拡張案（MVP外）

### 機能拡張
- [ ] ユーザー会員登録・ログイン
- [ ] 見積もりシミュレーション
- [ ] 比較機能（複数車両の比較表示）
- [ ] チャット機能
- [ ] 在庫通知機能（希望条件に合う車両の通知）

### 管理機能拡張
- [ ] 顧客管理（CRM）
- [ ] 販売履歴管理
- [ ] レポート・分析機能
- [ ] 権限管理（複数管理者）

### 技術的改善
- [ ] 画像最適化（WebP変換、リサイズ）
- [ ] フルテキスト検索
- [ ] キャッシング戦略
- [ ] PWA対応
- [ ] 多言語対応

---

## 付録

### CSVインポート形式サンプル

```csv
vehicle_id,manufacturer,model,grade,price,year,mileage,inspection_date,accident_history,notes
V001,トヨタ,プリウス,S,1500000,2020,30000,2026-03-15,false,ワンオーナー車、禁煙車
V002,ホンダ,フィット,RS,980000,2019,45000,2025-12-20,false,純正ナビ付き
```

### 環境変数一覧

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# Resend
RESEND_API_KEY=
ADMIN_EMAIL=
```

---

**文書バージョン**: 1.0  
**作成日**: 2024年2月  
**最終更新日**: 2024年2月
